<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Relief Allocator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/weekOfYear.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/isSameOrAfter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/isBetween.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        .rationale-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
        }
        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            text-align: center;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 9999px; /* circle */
        }
        .calendar-day:hover {
            background-color: #e0e7ff; /* indigo-100 */
        }
        .calendar-day.selected {
            background-color: #3b82f6; /* blue-600 */
            color: white;
            font-weight: bold;
        }
         .calendar-day.today {
            border: 1px solid #3b82f6;
        }
        .calendar-day.empty {
            cursor: default;
        }
        .calendar-day.empty:hover {
            background-color: transparent;
        }
        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            font-size: 0.75rem;
            color: #6b7280; /* gray-500 */
        }
        .tier-header th {
            background-color: #e5e7eb; /* gray-200 */
            text-align: left;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 700;
            color: #374151; /* gray-700 */
        }
        #blockOutBtn.block-out-active {
            background-color: #fee2e2; /* red-100 */
            color: #dc2626; /* red-600 */
            border: 1px solid #dc2626;
        }
        .highlight-col {
             background-color: #fef9c3 !important; /* yellow-100 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="flex h-screen">
        <!-- ===== Left Sidebar (Control Panel) ===== -->
        <aside class="w-72 bg-white border-r border-gray-200 flex flex-col p-4">
            <h1 class="text-2xl font-bold text-blue-600 mb-6">Smart Allocator</h1>
            
            <button id="assignReliefBtn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                Assign Relief
            </button>

            <div id="reliefStatusContainer" class="mt-6 mb-4 p-3 rounded-lg"></div>

            <div class="mt-8 flex-grow">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-semibold text-gray-700">Periods Requiring Relief</h2>
                    <button id="clearDayReliefBtn" title="Delete all relief tasks for this day" class="hidden text-xs text-red-500 hover:text-red-700 font-semibold p-1 hover:bg-red-100 rounded">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div id="reliefTasksSidebar" class="space-y-4">
                    <!-- Relief tasks will be injected here -->
                    <p class="text-sm text-gray-500 text-center py-4">No pending relief assignments.</p>
                </div>
            </div>

            <div class="text-xs text-gray-400 text-center">
                <p>&copy; 2025 School Timetabling Solutions</p>
            </div>
        </aside>

        <!-- ===== Main Content Area ===== -->
        <main class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 flex items-center justify-between p-4 shadow-sm">
                <div class="flex items-center">
                    <h2 class="text-xl font-semibold">Relief Allocation Dashboard</h2>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center bg-gray-100 rounded-lg p-1">
                        <button id="prevDayBtn" class="p-2 rounded-md hover:bg-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                        <span id="dateDisplay" class="font-semibold text-gray-700 px-4 whitespace-nowrap"></span>
                        <button id="nextDayBtn" class="p-2 rounded-md hover:bg-gray-200">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                        <button id="todayBtn" class="ml-2 px-3 py-1.5 text-sm font-semibold text-blue-600 bg-blue-100 rounded-md hover:bg-blue-200">Today</button>
                    </div>
                     <button id="blockOutBtn" class="p-2 rounded-full hover:bg-gray-200" title="Block Out Mode">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.367zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd" /></svg>
                     </button>
                     <button id="settingsBtn" class="p-2 rounded-full hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31-2.37 2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    </button>
                </div>
            </header>

             <!-- Block Out Mode Banner -->
            <div id="blockOutBanner" class="hidden bg-red-500 text-white text-center p-2 font-semibold flex justify-between items-center">
                <span>Block Out Mode is Active: Click on slots to toggle blocks.</span>
                <div class="space-x-2">
                    <button id="resetBlocksBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-bold py-1 px-3 rounded">Reset Blocks</button>
                    <button id="cancelBlockOutBtn" class="bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded">Cancel</button>
                    <button id="saveBlocksBtn" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-3 rounded">Done</button>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="bg-white border-b border-gray-200 px-6">
                <nav class="flex space-x-8 -mb-px">
                    <button data-tab="timetable" class="tab-button py-4 px-1 text-sm font-medium text-gray-500 hover:text-blue-600 hover:border-b-2 hover:border-blue-600 tab-active">Timetable & Allocation</button>
                    <button data-tab="load" class="tab-button py-4 px-1 text-sm font-medium text-gray-500 hover:text-blue-600 hover:border-b-2 hover:border-blue-600">Teacher Relief Load</button>
                    <button data-tab="summary" class="tab-button py-4 px-1 text-sm font-medium text-gray-500 hover:text-blue-600 hover:border-b-2 hover:border-blue-600">Daily Relief Summary</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="loadingOverlay" class="flex-1 p-6 overflow-y-auto flex items-center justify-center">
                <div class="text-center">
                    <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="mt-2 text-gray-500">Connecting to database...</p>
                </div>
            </div>

            <div id="mainContent" class="flex-1 p-6 overflow-y-auto hidden">
                <div id="timetable" class="tab-content">
                    <!-- Timetable will be rendered here -->
                </div>
                <div id="load" class="tab-content hidden">
                    <!-- Relief load overview will be injected here -->
                </div>
                <div id="summary" class="tab-content hidden">
                    <!-- Daily summary will be rendered here -->
                </div>
            </div>
        </main>
    </div>

    <!-- ===== Modals ===== -->
    <div id="modalBackdrop" class="modal-backdrop"></div>

    <!-- Assign Relief Modal -->
    <div id="assignReliefModal" class="modal w-full max-w-2xl bg-white rounded-xl shadow-2xl">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-xl font-semibold">Report Teacher Unavailability</h3>
                <button id="closeAssignReliefModal" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left side: Teacher and Calendar -->
                <div class="space-y-4">
                    <div>
                        <label for="teacherSelect" class="block text-sm font-medium text-gray-700">Select Teacher</label>
                        <select id="teacherSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Relief Date</label>
                        <div id="calendarContainer" class="mt-2 p-2 border rounded-md"></div>
                    </div>
                </div>
                <!-- Right side: Relief Type and Periods -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Relief Type</label>
                        <div id="reliefTypeContainer" class="mt-2 flex items-center space-x-4 text-sm">
                            <label class="flex items-center"><input type="radio" name="reliefType" value="specific" checked class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 mr-1"> Specific Periods</label>
                            <label class="flex items-center"><input type="radio" name="reliefType" value="range" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 mr-1"> Period Range</label>
                            <label class="flex items-center"><input type="radio" name="reliefType" value="fullDay" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 mr-1"> Full Day</label>
                        </div>
                        <div id="reliefSelectionSummary" class="text-sm text-gray-600 mt-2 min-h-[20px]"></div>
                    </div>

                    <div id="specificPeriodsWrapper">
                        <label class="block text-sm font-medium text-gray-700">Select Period(s) to Cover</label>
                        <div id="periodSelectContainer" class="mt-2 p-3 border border-gray-200 rounded-md h-48 overflow-y-auto bg-gray-50">
                            <p class="text-gray-500">Please select a teacher and date.</p>
                        </div>
                    </div>

                    <div id="rangePeriodsWrapper" class="hidden">
                        <label class="block text-sm font-medium text-gray-700">Select Period Range</label>
                        <div class="mt-2 flex items-center space-x-4">
                            <div class="flex-1">
                                <label for="startPeriodSelect" class="text-xs text-gray-600">From</label>
                                <select id="startPeriodSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                            </div>
                            <div class="flex-1">
                                <label for="endPeriodSelect" class="text-xs text-gray-600">To</label>
                                <select id="endPeriodSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <p id="modalErrorMessage" class="text-red-600 text-sm mt-4 text-center hidden"></p>
            <div id="modalActionButtons" class="mt-6 flex justify-between items-center">
                 <div class="space-x-3">
                    <button id="deleteAllTasksBtn" class="hidden bg-red-800 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-900 transition duration-300">Delete All for Day</button>
                    <button id="deleteReliefBtn" class="hidden bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition duration-300">Delete Period(s)</button>
                 </div>
                <button id="findTeachersBtn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">Find Available Teachers</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal w-full max-w-lg bg-white rounded-xl shadow-2xl">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Settings</h3>
                <button id="closeSettingsModal" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Import Timetable</label>
                    <p class="text-xs text-gray-500 mt-1">Upload the completed Excel file. Need the template? <a href="#" id="downloadTemplateLink" class="text-blue-600 hover:underline">Download it here</a>.</p>
                    <input type="file" id="fileUploader" class="hidden" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                    <button id="uploadBtn" class="mt-2 w-full flex justify-center items-center px-4 py-2 border border-dashed border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                        <span id="uploadBtnText">Upload CSV Timetable</span>
                    </button>
                </div>
                 <div class="border-t pt-6">
                    <label class="block text-sm font-medium text-gray-700">Term Start Dates</label>
                    <p class="text-xs text-gray-500 mt-1">Set the start date for Week 1 of each term. Weeks will alternate between Odd and Even from these dates.</p>
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <div>
                            <label for="term1" class="block text-xs font-medium text-gray-600">Term 1 (Odd)</label>
                            <input type="date" id="term1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-sm">
                        </div>
                        <div>
                            <label for="term2" class="block text-xs font-medium text-gray-600">Term 2 (Odd)</label>
                            <input type="date" id="term2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-sm">
                        </div>
                        <div>
                            <label for="term3" class="block text-xs font-medium text-gray-600">Term 3 (Odd)</label>
                            <input type="date" id="term3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-sm">
                        </div>
                         <div>
                            <label for="term4" class="block text-xs font-medium text-gray-600">Term 4 (Odd)</label>
                            <input type="date" id="term4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-sm">
                        </div>
                    </div>
                </div>
            </div>
             <div class="mt-6 flex justify-end">
                <button id="saveSettingsBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Save & Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE ---
        const firebaseConfig = {
             apiKey: "AIzaSyB_CI1CbYU7cpXGg4RTFSIQsy2SCao3AqU",
             authDomain: "smart-relief-system.firebaseapp.com",
             projectId: "smart-relief-system",
             storageBucket: "smart-relief-system.firebasestorage.app",
             messagingSenderId: "868354849156",
             appId: "1:868354849156:web:1b2eb289950327955e45d1"
        };
        // ---------------------------------------------------------

        function initializeFirebase() {
            try {
                // A simple check to see if the config is still the default placeholder
                if (!firebaseConfig.projectId || firebaseConfig.apiKey === "...") {
                    throw new Error("'projectId' or other essential keys not provided in firebaseConfig.");
                }
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setupApp(db);
                    } else {
                        signInAnonymously(auth).catch((error) => {
                            console.error("Anonymous sign-in failed:", error);
                            alert("Could not connect to the database. Please check your Firebase setup and security rules.");
                        });
                    }
                });
            } catch (e) {
                console.warn("Firebase initialization failed:", e.message);
                document.getElementById('loadingOverlay').innerHTML = `<div class="text-center p-4 bg-red-100 rounded-lg"><p class="font-bold text-red-700">Firebase Configuration Missing</p><p class="text-sm text-red-600 mt-2">Please paste your Firebase config object into the script tag in <code>index.html</code> to connect the application to your database.</p></div>`;
            }
        }

        function setupApp(db) {
            const dataDocRef = doc(db, "app_data", "main");
            
            runApp(db); 

            onSnapshot(dataDocRef, (docSnap) => {
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.loadStateFromFirestore(data);
                } else {
                    window.initializeAppStateAndSave();
                }
            });
        }
        
        function runApp(db) {
            
            dayjs.extend(window.dayjs_plugin_weekOfYear);
            dayjs.extend(window.dayjs_plugin_isSameOrAfter);
            dayjs.extend(window.dayjs_plugin_isBetween);
    
            const PERIODS = [
                { id: 1, time: '08:00-08:35' }, { id: 2, time: '08:35-09:10' },
                { id: 3, time: '09:10-09:45' }, { id: 4, time: '09:45-10:20' },
                { id: 5, time: '10:50-11:25' }, { id: 6, time: '11:25-12:00' },
                { id: 7, time: '12:00-12:35' }, { id: 8, time: '12:35-13:10' },
                { id: 9, time: '14:00-14:35' }, { id: 10, time: '14:35-15:10' },
                { id: 11, time: '15:10-15:45' }, { id: 12, time: '15:45-16:20' },
                { id: 13, time: '16:35-17:10' }, { id: 14, time: '17:10-17:45' },
                { id: 15, time: '17:45-18:20' }, { id: 16, time: '18:20-18:55' }
            ];
    
            let masterTeachers = [];
            let teachers = []; 
            let reliefTasksByDate = {};
    
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const assignReliefBtn = document.getElementById('assignReliefBtn');
            const assignReliefModal = document.getElementById('assignReliefModal');
            const modalBackdrop = document.getElementById('modalBackdrop');
            const closeAssignReliefModalBtn = document.getElementById('closeAssignReliefModal');
            const teacherSelect = document.getElementById('teacherSelect');
            const periodSelectContainer = document.getElementById('periodSelectContainer');
            const findTeachersBtn = document.getElementById('findTeachersBtn');
            const deleteReliefBtn = document.getElementById('deleteReliefBtn');
            const dateDisplay = document.getElementById('dateDisplay');
            const prevDayBtn = document.getElementById('prevDayBtn');
            const nextDayBtn = document.getElementById('nextDayBtn');
            const todayBtn = document.getElementById('todayBtn');
            const calendarContainer = document.getElementById('calendarContainer');
            const reliefTypeContainer = document.getElementById('reliefTypeContainer');
            const specificPeriodsWrapper = document.getElementById('specificPeriodsWrapper');
            const rangePeriodsWrapper = document.getElementById('rangePeriodsWrapper');
            const startPeriodSelect = document.getElementById('startPeriodSelect');
            const endPeriodSelect = document.getElementById('endPeriodSelect');
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsModal = document.getElementById('closeSettingsModal');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const downloadTemplateLink = document.getElementById('downloadTemplateLink');
            const uploadBtn = document.getElementById('uploadBtn');
            const fileUploader = document.getElementById('fileUploader');
            const modalTitle = document.getElementById('modalTitle');
            const term1Input = document.getElementById('term1');
            const term2Input = document.getElementById('term2');
            const term3Input = document.getElementById('term3');
            const term4Input = document.getElementById('term4');
            const timetableTab = document.getElementById('timetable');
            const blockOutBtn = document.getElementById('blockOutBtn');
            const blockOutBanner = document.getElementById('blockOutBanner');
            const saveBlocksBtn = document.getElementById('saveBlocksBtn'); 
            const resetBlocksBtn = document.getElementById('resetBlocksBtn');
            const cancelBlockOutBtn = document.getElementById('cancelBlockOutBtn');
            const deleteAllTasksBtn = document.getElementById('deleteAllTasksBtn');
            const clearDayReliefBtn = document.getElementById('clearDayReliefBtn');
    
            let selectedReliefContext = null;
            let fullTimetable = {}; 
            let calendarDisplayMonth = dayjs();
            let selectedReliefDateInModal = dayjs();
            let currentViewDate = dayjs();

            const dayOfWeekInit = currentViewDate.day(); 
            if (dayOfWeekInit === 6) { 
                currentViewDate = currentViewDate.add(2, 'day');
            } else if (dayOfWeekInit === 0) { 
                currentViewDate = currentViewDate.add(1, 'day');
            }
            let modalMode = 'new';
            let taskToEdit = null;
            let isBlockOutMode = false;
            let blockOutTeachers = [];
    
            let termStartDates = {
                term1: dayjs('2025-01-02'),
                term2: dayjs('2025-03-24'),
                term3: dayjs('2025-06-30'),
                term4: dayjs('2025-09-15'),
            };
    
            const getPeriodDetails = (periodId) => PERIODS.find(p => p.id === periodId);
            const getMasterTeacherDetails = (teacherId) => masterTeachers.find(t => t.id === teacherId);
            const getTeacherTimetableSlot = (teacher, periodId) => teacher.timetable.find(slot => slot.period === periodId);
            const countDailyLoad = (teacher) => teacher.timetable.filter(slot => slot.status === 'teaching' || slot.status === 'relief').length;
    
            const openModal = (modal) => {
                modalBackdrop.style.display = 'block';
                modal.style.display = 'block';
            }
            const closeModal = (modal) => {
                modalBackdrop.style.display = 'none';
                modal.style.display = 'none';
            }

            async function saveStateToFirestore() {
                const stateToSave = {
                    fullTimetable,
                    reliefTasksByDate,
                    termStartDates: { 
                        term1: termStartDates.term1.format(),
                        term2: termStartDates.term2.format(),
                        term3: termStartDates.term3.format(),
                        term4: termStartDates.term4.format(),
                    },
                    masterTeachers
                };
                try {
                    await setDoc(doc(db, "app_data", "main"), stateToSave);
                } catch (e) {
                    console.error("Error saving state to Firestore: ", e);
                }
            }

            window.initializeAppStateAndSave = function() {
                initializeMockFullTimetable();
                if (Object.keys(reliefTasksByDate).length === 0) {
                    addMockReliefTasks(currentViewDate);
                }
                initializeAppUI();
                saveStateToFirestore();
            }

            window.loadStateFromFirestore = function(data) {
                fullTimetable = data.fullTimetable || {};
                reliefTasksByDate = data.reliefTasksByDate || {};
                masterTeachers = data.masterTeachers || [];
                if (data.termStartDates) {
                    termStartDates = { 
                        term1: dayjs(data.termStartDates.term1),
                        term2: dayjs(data.termStartDates.term2),
                        term3: dayjs(data.termStartDates.term3),
                        term4: dayjs(data.termStartDates.term4),
                    };
                }
                initializeAppUI();
            }

            function initializeAppUI() {
                if (masterTeachers.length > 0) {
                    teacherSelect.innerHTML = '<option value="">Select a teacher...</option>' + masterTeachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                }
                term1Input.value = termStartDates.term1.format('YYYY-MM-DD');
                term2Input.value = termStartDates.term2.format('YYYY-MM-DD');
                term3Input.value = termStartDates.term3.format('YYYY-MM-DD');
                term4Input.value = termStartDates.term4.format('YYYY-MM-DD');
                loadTimetableForDate(currentViewDate);
            }
        
            function renderReliefTasksSidebar() {
                // This function remains the same as your previous version
                // ... (renderReliefTasksSidebar logic) ...
            }
            
            // ... (all your other functions: renderDepartmentTimetable, renderReliefLoad, etc.)
            
            initializeApp();

            // ... (rest of functions) ...
            function renderReliefTasksSidebar() {
                const container = document.getElementById('reliefTasksSidebar');
                const clearDayBtn = document.getElementById('clearDayReliefBtn');
                const dateKey = currentViewDate.format('YYYY-MM-DD');
                const tasksForDay = (reliefTasksByDate[dateKey] || []);

                if (tasksForDay.length === 0) {
                    container.innerHTML = `<p class="text-sm text-gray-500 text-center py-4">No pending relief assignments.</p>`;
                    if(clearDayBtn) clearDayBtn.classList.add('hidden');
                    return;
                }

                if(clearDayBtn) clearDayBtn.classList.remove('hidden');

                // Group tasks by teacher
                const tasksByTeacher = tasksForDay.reduce((acc, task) => {
                    const teacherId = task.originalTeacher.id;
                    if (!acc[teacherId]) {
                        acc[teacherId] = {
                            teacher: task.originalTeacher,
                            tasks: []
                        };
                    }
                    acc[teacherId].tasks.push(task);
                    return acc;
                }, {});

                let html = '';
                for (const teacherId in tasksByTeacher) {
                    const group = tasksByTeacher[teacherId];
                    // Sort tasks within the group
                    group.tasks.sort((a, b) => {
                        const statusOrder = { 'pending': 0, 'assigned': 1 };
                        return statusOrder[a.status] - statusOrder[b.status] || a.periods[0].id - b.periods[0].id;
                    });

                    html += `
                        <div class="mb-4">
                            <div class="flex justify-between items-center bg-gray-200 p-2 rounded-t-lg">
                                <p class="font-bold text-sm text-gray-700">${group.teacher.name}</p>
                            </div>
                            <div class="border border-t-0 rounded-b-lg p-2 space-y-2">
                    `;
                    
                    html += group.tasks.map((task, index) => {
                        const periodText = task.periods.length > 1 
                            ? `P${task.periods[0].id}-P${task.periods[task.periods.length - 1].id}`
                            : `P${task.periods[0].id}`;

                        let splitButton = '';
                        if (task.periods.length > 1 && task.status === 'pending') {
                            const weekType = getWeekType(dayjs(task.date));
                            const dayOfWeek = dayjs(task.date).format('dddd').toLowerCase();
                            const teacherTimetable = fullTimetable[task.originalTeacher.id]?.[weekType]?.[dayOfWeek] || [];
                            
                            const firstPeriodDetails = task.details;
                            const isPerfectMatch = task.periods.every(p => {
                                const slot = teacherTimetable.find(s => s.period === p.id);
                                return slot && slot.subject === firstPeriodDetails.subject && slot.level === firstPeriodDetails.level && slot.stream === firstPeriodDetails.stream;
                            });

                            if (isPerfectMatch) {
                                splitButton = `<button data-task-id="${task.id}" class="split-task-btn text-xs text-blue-600 hover:underline mt-1 text-left">Split Assignment</button>`;
                            }
                        }
        
                        let combineButton = '';
                        const nextTaskIndex = index + 1;
                        if (task.periods.length >= 1 && nextTaskIndex < group.tasks.length) {
                            const nextTask = group.tasks[nextTaskIndex];
                            const lastPeriodOfCurrent = task.periods[task.periods.length - 1].id;
                            if (nextTask.originalTeacher.id === task.originalTeacher.id &&
                                nextTask.periods[0].id === lastPeriodOfCurrent + 1 &&
                                nextTask.details.subject === task.details.subject && 
                                nextTask.details.level === task.details.level && 
                                nextTask.details.stream === task.details.stream) {
                                combineButton = `<button data-task-id="${task.id}" class="combine-task-btn text-xs text-green-600 hover:underline mt-1 text-left">Combine with next</button>`;
                            }
                        }
                        
                        const cardBgClass = task.status === 'assigned' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800';
                        const selectedClass = selectedReliefContext && selectedReliefContext.id === task.id ? 'bg-blue-100 ring-2 ring-blue-500 text-blue-800' : `${cardBgClass} hover:opacity-80`;

                        let actionButtonHTML = `<button data-task-id="${task.id}" class="edit-task-btn p-1.5 hover:bg-gray-300 rounded-full"><svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>`;
                        if (task.status === 'assigned') {
                            actionButtonHTML = `<button data-task-id="${task.id}" class="undo-task-btn p-1.5 hover:bg-gray-300 rounded-full" title="Undo Assignment"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg></button>`;
                        }
                        
                        const multiPeriodIndicator = task.periods.length > 1 ? '<div class="absolute left-0 top-0 h-full w-1.5 bg-blue-500 rounded-l-lg"></div>' : '';
                        const paddingClass = task.periods.length > 1 ? 'pl-6' : 'pl-3';
        
                        return `
                        <div data-task-id="${task.id}" class="relative relief-task-item py-3 pr-3 ${paddingClass} rounded-lg cursor-pointer ${selectedClass}">
                            ${multiPeriodIndicator}
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-semibold text-sm">${task.periods[0].time} - ${periodText} (${task.periods.length} Period${task.periods.length > 1 ? 's' : ''})</p>
                                    <p class="text-xs">${task.details.level} ${task.details.subject} (${task.details.stream})</p>
                                    <p class="text-xs text-current opacity-75">Original: ${task.originalTeacher.name}</p>
                                    <div class="flex space-x-2">${splitButton} ${combineButton}</div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${actionButtonHTML}
                                </div>
                            </div>
                        </div>
                    `}).join('');

                    html += `</div></div>`; // close the group div
                }

                container.innerHTML = html;
    
                container.querySelectorAll('.relief-task-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (e.target.closest('.edit-task-btn') || e.target.closest('.split-task-btn') || e.target.closest('.combine-task-btn') || e.target.closest('.undo-task-btn')) return;
                        const taskId = item.dataset.taskId;
                        const context = tasksForDay.find(t => t.id === taskId);
                        if (context) {
                            selectedReliefContext = context;
                            renderUI();
                        }
                    });
                });
    
                container.querySelectorAll('.edit-task-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const taskId = btn.dataset.taskId;
                        const task = tasksForDay.find(t => t.id === taskId);
                        if (task) {
                            openEditModal(task);
                        }
                    });
                });
                
                container.querySelectorAll('.split-task-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const taskId = btn.dataset.taskId;
                        handleSplitAssignment(taskId);
                    });
                });

                container.querySelectorAll('.combine-task-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const taskId = btn.dataset.taskId;
                        handleCombineAssignments(taskId);
                    });
                });

                container.querySelectorAll('.undo-task-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const taskId = btn.dataset.taskId;
                        handleUndoAssignment(taskId);
                    });
                });
            }
            
            function renderDepartmentTimetable() {
                const container = document.getElementById('timetable');
                 if (!teachers || teachers.length === 0) {
                    container.innerHTML = `<div class="text-center p-8"><p class="text-gray-500">No teacher data is available to display the timetable.</p></div>`;
                    return;
                }
    
                try {
                    const currentTimetableData = isBlockOutMode ? blockOutTeachers : teachers;
    
                    const highlightedPeriods = new Set(selectedReliefContext ? selectedReliefContext.periods.map(p => p.id) : []);
                    const headerHtml = PERIODS.map(p => `<th class="sticky top-0 bg-gray-50 z-10 p-2 border font-semibold text-sm whitespace-nowrap period-header-cell cursor-pointer hover:bg-gray-200 ${highlightedPeriods.has(p.id) ? 'highlight-col' : ''}" data-period-id="${p.id}">${p.time}<br>P${p.id}</th>`).join('');
                    
                    const renderTeacherRow = (teacher) => {
                        let assignButton = '';
                        let constraintsDisplay = ''; 

                        if (selectedReliefContext?.status === 'pending' && !isBlockOutMode) {
                            const candidateGroups = findAndRankTeachers(selectedReliefContext);
                            const candidate = [...candidateGroups.G1, ...candidateGroups.G2, ...candidateGroups.G3, ...candidateGroups.G4].find(c => c.teacher.id === teacher.id);

                            if (candidate) {
                                let rationaleHtml = `<div class="mt-1 text-xs text-gray-600 rationale-grid">`;
                                for (const [key, value] of Object.entries(candidate.rationale)) {
                                     rationaleHtml += `<span>${key}: <span class="font-semibold text-gray-800">${value}</span></span>`;
                                }
                                rationaleHtml += '</div>';
                                constraintsDisplay = rationaleHtml;

                                const isAssignable = [...candidateGroups.G1, ...candidateGroups.G2, ...candidateGroups.G3].some(c => c.teacher.id === teacher.id);
                                const isTier4 = candidateGroups.G4.some(c => c.teacher.id === teacher.id);
                                
                                if (isAssignable) {
                                    assignButton = `<button data-teacher-id="${teacher.id}" class="assign-in-timetable-btn mt-2 w-full bg-green-500 text-white text-xs font-bold py-1 px-2 rounded hover:bg-green-600 transition">Assign</button>`;
                                } else if (isTier4) {
                                     assignButton = `<button data-teacher-id="${teacher.id}" class="assign-in-timetable-btn mt-2 w-full bg-orange-500 text-white text-xs font-bold py-1 px-2 rounded hover:bg-orange-600 transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                        Assign Anyway
                                    </button>`;
                                }
                            }
                        }

                        const rowClass = teacher.available ? 'bg-white' : 'bg-gray-200 opacity-60';
    
                        const cellsHtml = PERIODS.map(period => {
                            const slot = getTeacherTimetableSlot(teacher, period.id);
                            let cellContent = '', cellClass = 'bg-green-100 text-green-800';
                             if (highlightedPeriods.has(period.id)) cellClass = 'highlight-col';
    
                            if (isBlockOutMode && slot?.status === 'blocked' && teacher.available) {
                                cellClass = `bg-gray-400 text-white ${highlightedPeriods.has(period.id) ? 'highlight-col' : ''}`;
                                cellContent = 'BLOCKED';
                            } else if (slot?.status === 'teaching') {
                                cellClass = `bg-blue-100 text-blue-800 ${highlightedPeriods.has(period.id) ? 'highlight-col' : ''}`;
                                cellContent = `<div class="font-semibold">${slot.level} ${slot.subject || ''}</div><div class="text-xs">${slot.stream || ''}</div>`;
                            } else if (slot?.status === 'relief') {
                                cellClass = `bg-orange-200 text-orange-800 animate-pulse ${highlightedPeriods.has(period.id) ? 'highlight-col' : ''}`;
                                cellContent = `<div class="font-semibold">RELIEF</div><div class="text-xs">${slot.subject || ''}</div>`;
                            } else if (slot?.status === 'blocked') {
                                cellClass = `bg-gray-400 text-white ${highlightedPeriods.has(period.id) ? 'highlight-col' : ''}`;
                                cellContent = `BLOCKED`;
                            } else if (!teacher.available) {
                                cellClass = `bg-red-100 text-red-800 ${highlightedPeriods.has(period.id) ? 'highlight-col' : ''}`;
                                if(slot?.status === 'teaching') {
                                     cellContent = `<div class="font-semibold">${slot.level} ${slot.subject || ''}</div><div class="text-xs">${slot.stream || ''}</div>`;
                                }
                            }
                            return `<td class="p-1 border text-center text-xs timetable-slot-cell cursor-pointer hover:bg-gray-200 ${cellClass}" data-teacher-id="${teacher.id}" data-period-id="${period.id}">${cellContent}</td>`;
                        }).join('');
    
                        return `<tr class="${rowClass}">
                            <td class="sticky left-0 p-2 border font-semibold bg-gray-50 whitespace-nowrap teacher-name-cell cursor-pointer hover:bg-gray-200" data-teacher-id="${teacher.id}">
                                <div>${teacher.name}</div>
                                ${constraintsDisplay}
                                ${assignButton}
                            </td>
                            ${cellsHtml}
                        </tr>`;
                    };
    
                    let bodyHtml = '';
                    if (selectedReliefContext && !isBlockOutMode) {
                        const candidateGroups = findAndRankTeachers(selectedReliefContext);
                        
                        const renderGroupHTML = (title, teachers) => {
                            if (teachers.length === 0) return '';
                            let groupHtml = `<tr class="tier-header sticky top-0 z-10"><th colspan="${PERIODS.length + 1}">${title}</th></tr>`;
                            teachers.forEach(c => groupHtml += renderTeacherRow(c.teacher));
                            return groupHtml;
                        };
                        
                        bodyHtml += renderGroupHTML('Tier 1: Perfect Match', candidateGroups.G1);
                        bodyHtml += renderGroupHTML('Tier 2: Subject Specialist', candidateGroups.G2);
                        bodyHtml += renderGroupHTML('Tier 3: Other Teachers Available', candidateGroups.G3);
                        bodyHtml += renderGroupHTML('Tier 4: Teacher(s) Unavailable', candidateGroups.G4);
    
                    } else {
                         currentTimetableData.forEach(teacher => {
                            bodyHtml += renderTeacherRow(teacher);
                        });
                    }
    
                    container.innerHTML = `
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead><tr><th class="sticky top-0 left-0 bg-gray-50 z-20 p-2 border">Teacher</th>${headerHtml}</tr></thead>
                                <tbody>${bodyHtml}</tbody>
                            </table>
                        </div>`;
    
                    container.querySelectorAll('.assign-in-timetable-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const teacherId = e.target.closest('button').dataset.teacherId;
                            handleAssignment(teacherId);
                        });
                    });
                     container.querySelectorAll('.timetable-slot-cell').forEach(cell => {
                        cell.addEventListener('click', () => {
                             if (isBlockOutMode) {
                                const teacherId = cell.dataset.teacherId;
                                const periodId = parseInt(cell.dataset.periodId);
                                toggleBlockOut(teacherId, periodId);
                             }
                        });
                    });
                     container.querySelectorAll('.teacher-name-cell, .period-header-cell').forEach(cell => {
                        cell.addEventListener('click', () => {
                             if (isBlockOutMode) {
                                if (cell.classList.contains('teacher-name-cell')) {
                                    toggleBlockOut(cell.dataset.teacherId, null); // Block whole day
                                } else {
                                     toggleBlockOut(null, parseInt(cell.dataset.periodId)); // Block period for all
                                }
                             }
                        });
                    });
    
                } catch (error) {
                    console.error("Error rendering department timetable:", error);
                    container.innerHTML = `<div class="text-center p-8"><p class="text-red-500">An error occurred while displaying the timetable.</p></div>`;
                }
            }
            
            function renderReliefLoad() {
                const container = document.getElementById('load');
                if (!masterTeachers || masterTeachers.length === 0) {
                    container.innerHTML = `<div class="text-center p-8"><p class="text-gray-500">No teacher data is available to display relief load.</p></div>`;
                    return;
                }

                const year = currentViewDate.year();
                const terms = [
                    { name: 'term1', start: termStartDates.term1, end: termStartDates.term2.subtract(1, 'day') },
                    { name: 'term2', start: termStartDates.term2, end: termStartDates.term3.subtract(1, 'day') },
                    { name: 'term3', start: termStartDates.term3, end: termStartDates.term4.subtract(1, 'day') },
                    { name: 'term4', start: termStartDates.term4, end: dayjs(`${year}-12-31`) }
                ];

                const startOfWeek = currentViewDate.startOf('week');
                const endOfWeek = currentViewDate.endOf('week');

                const loadData = masterTeachers.map(teacher => {
                    const loads = {
                        name: teacher.name,
                        weekly: 0,
                        term1: 0,
                        term2: 0,
                        term3: 0,
                        term4: 0,
                        total: 0
                    };

                    for (const dateKey in reliefTasksByDate) {
                        const tasksOnDate = reliefTasksByDate[dateKey];
                        const tasksForTeacher = tasksOnDate.filter(task => task.assignedTeacher && task.assignedTeacher.id === teacher.id);
                        if (tasksForTeacher.length === 0) continue;

                        const taskDate = dayjs(dateKey);
                        const periodCount = tasksForTeacher.reduce((sum, task) => sum + task.periods.length, 0);

                        // Calculate weekly load
                        if (taskDate.isBetween(startOfWeek, endOfWeek, 'day', '[]')) {
                            loads.weekly += periodCount;
                        }

                        // Calculate termly load
                        for (let i = 0; i < terms.length; i++) {
                            if (taskDate.isBetween(terms[i].start, terms[i].end, 'day', '[]')) {
                                loads[terms[i].name] += periodCount;
                                break; // A date can only be in one term
                            }
                        }
                    }
                    
                    loads.total = loads.term1 + loads.term2 + loads.term3 + loads.term4;
                    return loads;

                }).sort((a, b) => b.total - a.total);


                const tableRows = loadData.map(d => `
                    <tr class="border-b">
                        <td class="sticky left-0 bg-white p-3 font-medium">${d.name}</td>
                        <td class="p-3 text-center">${d.weekly}</td>
                        <td class="p-3 text-center">${d.term1}</td>
                        <td class="p-3 text-center">${d.term2}</td>
                        <td class="p-3 text-center">${d.term3}</td>
                        <td class="p-3 text-center">${d.term4}</td>
                        <td class="p-3 text-center font-semibold">${d.total}</td>
                    </tr>
                `).join('');

                container.innerHTML = `
                    <h3 class="text-xl font-semibold mb-2">Teacher Relief Load Summary</h3>
                    <p class="text-sm text-gray-600 mb-4">Showing weekly load for ${startOfWeek.format('D MMM')} to ${endOfWeek.format('D MMM YYYY')}</p>
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table class="w-full text-sm text-left">
                            <thead class="sticky top-0 bg-gray-100 z-10">
                                <tr>
                                    <th class="sticky left-0 bg-gray-100 p-3">Teacher</th>
                                    <th class="p-3 text-center">Current Week</th>
                                    <th class="p-3 text-center">Term 1</th>
                                    <th class="p-3 text-center">Term 2</th>
                                    <th class="p-3 text-center">Term 3</th>
                                    <th class="p-3 text-center">Term 4</th>
                                    <th class="p-3 text-center">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            function toggleBlockOut(teacherId, periodId) {
                if (!isBlockOutMode) return;
    
                blockOutTeachers = blockOutTeachers.map(teacher => {
                     // If teacherId is provided, and it's either a specific period or the whole day
                    if (teacherId && teacher.id === teacherId) {
                        const newTimetable = teacher.timetable.map(slot => {
                            // If periodId is provided (single slot) or not (whole day)
                            if (slot.status === 'free' && (!periodId || slot.period === periodId)) {
                                return { ...slot, status: 'blocked' };
                            } else if (slot.status === 'blocked' && (!periodId || slot.period === periodId)) {
                                 return { ...slot, status: 'free' };
                            }
                            return slot;
                        });
                        return { ...teacher, timetable: newTimetable };
                    }
                    return teacher;
                });
    
                // If periodId is provided but teacherId is not (block for all teachers)
                 if (periodId && !teacherId) {
                     blockOutTeachers = blockOutTeachers.map(teacher => {
                         if (!teacher.available) return teacher; // Don't modify unavailable teachers
                         const slotToToggle = teacher.timetable.find(s => s.period === periodId);
                         // Check if ALL teachers are blocked for this period to unblock all
                         const allBlocked = blockOutTeachers.every(t => !t.available || t.timetable.find(s => s.period === periodId)?.status !== 'free');
                         const newStatus = allBlocked ? 'free' : 'blocked';
                         
                         const newTimetable = teacher.timetable.map(slot => {
                             if (slot.period === periodId && (slot.status === 'free' || slot.status === 'blocked')) {
                                  return { ...slot, status: newStatus };
                             }
                             return slot;
                         });
                         return { ...teacher, timetable: newTimetable };
                     });
                 }
                renderDepartmentTimetable();
            }
            
             function enterBlockOutMode() {
                isBlockOutMode = true;
                blockOutTeachers = JSON.parse(JSON.stringify(teachers)); // Deep copy for editing
                blockOutBtn.classList.add('block-out-active');
                blockOutBanner.classList.remove('hidden');
                assignReliefBtn.disabled = true;
                document.getElementById('reliefTasksSidebar').style.opacity = '0.5';
                renderDepartmentTimetable();
            }
    
            function exitBlockOutMode(saveChanges = false) {
                 if (saveChanges) {
                     blockOutTeachers.forEach(blockedTeacher => {
                         const masterTeacher = getMasterTeacherDetails(blockedTeacher.id);
                         if (masterTeacher) {
                              const dateKey = currentViewDate.format('YYYY-MM-DD');
                             if(!masterTeacher.blockedSlotsByDate) masterTeacher.blockedSlotsByDate = {};
                             
                             masterTeacher.blockedSlotsByDate[dateKey] = blockedTeacher.timetable
                                 .filter(s => s.status === 'blocked')
                                 .map(s => s.period);
                         }
                     });
                     saveStateToFirestore();
                 }
                
                isBlockOutMode = false;
                blockOutBtn.classList.remove('block-out-active');
                blockOutBanner.classList.add('hidden');
                assignReliefBtn.disabled = false;
                document.getElementById('reliefTasksSidebar').style.opacity = '1';
                
                if (!saveChanges) {
                    renderDepartmentTimetable(); // Re-render with original data
                }
            }
            
            function openEditModal(task) {
                modalMode = 'edit';
                taskToEdit = task;
                modalTitle.textContent = "Edit Relief Assignment";
                
                const originalTeacher = task.originalTeacher;
                teacherSelect.value = originalTeacher.id;
                
                selectedReliefDateInModal = dayjs(task.date);
                calendarDisplayMonth = selectedReliefDateInModal;
                renderCalendar();
                
                const isFullDay = task.periods.length === PERIODS.length;
                const isRange = task.periods.length > 1 && !isFullDay;
    
                if (isFullDay) {
                    document.querySelector('input[name="reliefType"][value="fullDay"]').checked = true;
                } else if (isRange) {
                    document.querySelector('input[name="reliefType"][value="range"]').checked = true;
                    startPeriodSelect.value = task.periods[0].id;
                    endPeriodSelect.value = task.periods[task.periods.length - 1].id;
                } else {
                    document.querySelector('input[name="reliefType"][value="specific"]').checked = true;
                }
                
                togglePeriodSelectionUI();
                updatePeriodSelectionForTeacher(originalTeacher.id);
    
                setTimeout(() => { // ensure UI is updated before setting checkboxes
                     task.periods.forEach(p => {
                        const checkbox = document.getElementById(`period-${p.id}`);
                        if (checkbox) checkbox.checked = true;
                    });
                    updateModalInteractiveState();
                }, 100);
    
                findTeachersBtn.textContent = "Update Assignment";
                deleteReliefBtn.textContent = "Delete Period(s)";
                deleteReliefBtn.classList.remove('hidden');
                deleteAllTasksBtn.classList.remove('hidden');
                openModal(assignReliefModal);
            }
    
            function resetAssignReliefModal() {
                modalMode = 'new';
                taskToEdit = null;
                modalTitle.textContent = "Report Teacher Unavailability";
                teacherSelect.value = '';
                selectedReliefDateInModal = dayjs();
                calendarDisplayMonth = dayjs();
                renderCalendar();
                document.querySelector('input[name="reliefType"][value="specific"]').checked = true;
                togglePeriodSelectionUI();
                periodSelectContainer.innerHTML = `<p class="text-gray-500">Please select a teacher and date.</p>`;
                findTeachersBtn.textContent = "Find Available Teachers";
                deleteReliefBtn.classList.add('hidden');
                deleteAllTasksBtn.classList.add('hidden');
                findTeachersBtn.disabled = true;
            }
    
            function renderCalendar() {
                const startOfMonth = calendarDisplayMonth.startOf('month');
                const endOfMonth = calendarDisplayMonth.endOf('month');
                const firstDayOfWeek = startOfMonth.day(); // 0 (Sun) to 6 (Sat)
    
                let html = `<div class="flex justify-between items-center mb-2 px-2">
                                <button id="calPrev" class="p-1 rounded-full hover:bg-gray-200">&lt;</button>
                                <span class="font-semibold text-sm">${calendarDisplayMonth.format('MMMM YYYY')}</span>
                                <button id="calNext" class="p-1 rounded-full hover:bg-gray-200">&gt;</button>
                            </div>
                            <div class="calendar-grid">`;
    
                ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => {
                    html += `<div class="calendar-day-header">${day}</div>`;
                });
    
                for (let i = 0; i < firstDayOfWeek; i++) {
                    html += `<div class="calendar-day empty"></div>`;
                }
    
                for (let day = 1; day <= endOfMonth.date(); day++) {
                    const current = calendarDisplayMonth.date(day);
                    const isSelected = current.isSame(selectedReliefDateInModal, 'day');
                    const isToday = current.isSame(dayjs(), 'day');
                    let classes = 'calendar-day';
                    if (isSelected) classes += ' selected';
                    if (isToday) classes += ' today';
    
                    html += `<div class="${classes}" data-date="${current.format('YYYY-MM-DD')}">${day}</div>`;
                }
                html += `</div>`;
                calendarContainer.innerHTML = html;
    
                calendarContainer.querySelector('#calPrev').addEventListener('click', () => {
                    calendarDisplayMonth = calendarDisplayMonth.subtract(1, 'month');
                    renderCalendar();
                });
                calendarContainer.querySelector('#calNext').addEventListener('click', () => {
                    calendarDisplayMonth = calendarDisplayMonth.add(1, 'month');
                    renderCalendar();
                });
                calendarContainer.querySelectorAll('.calendar-day:not(.empty)').forEach(dayEl => {
                    dayEl.addEventListener('click', () => {
                        selectedReliefDateInModal = dayjs(dayEl.dataset.date);
                        renderCalendar();
                        const teacherId = teacherSelect.value;
                        if (teacherId) {
                            updatePeriodSelectionForTeacher(teacherId);
                        }
                        updateModalInteractiveState();
                    });
                });
            }
    
            function togglePeriodSelectionUI() {
                const selectedType = document.querySelector('input[name="reliefType"]:checked').value;
                specificPeriodsWrapper.classList.toggle('hidden', selectedType !== 'specific');
                rangePeriodsWrapper.classList.toggle('hidden', selectedType !== 'range');
            }
            
            function getWeekType(date) {
                const checkDate = dayjs(date);
                let closestTermStart, termWeekType = 'Odd';

                const sortedTerms = Object.entries(termStartDates)
                    .map(([key, startDate]) => ({ key, startDate }))
                    .sort((a, b) => a.startDate.diff(b.startDate));

                for (let i = sortedTerms.length - 1; i >= 0; i--) {
                    if (checkDate.isSameOrAfter(sortedTerms[i].startDate, 'day')) {
                        closestTermStart = sortedTerms[i].startDate;
                        break;
                    }
                }
                 if (!closestTermStart) return 'Odd';

                const weekNumber = checkDate.week();
                const startWeekNumber = closestTermStart.week();
                const weekDifference = weekNumber - startWeekNumber;

                return (weekDifference % 2 === 0) ? termWeekType : 'Even';
            }
    
    
            function updatePeriodSelectionForTeacher(teacherId) {
                findTeachersBtn.disabled = true;
                const teacher = getMasterTeacherDetails(teacherId);
                if (!teacher) {
                    periodSelectContainer.innerHTML = `<p class="text-gray-500">Teacher not found.</p>`;
                    return;
                }
                
                const weekType = getWeekType(selectedReliefDateInModal);
                const dayOfWeek = selectedReliefDateInModal.format('dddd').toLowerCase();
                const teacherTimetableForDay = (fullTimetable[teacherId]?.[weekType]?.[dayOfWeek] || []);
    
                if (teacherTimetableForDay.length === 0) {
                     periodSelectContainer.innerHTML = `<p class="text-gray-500">No classes scheduled for this teacher on this day.</p>`;
                     return;
                }
    
                periodSelectContainer.innerHTML = teacherTimetableForDay.map(slot => {
                    const periodDetails = getPeriodDetails(slot.period);
                     return `<label class="flex items-center p-2 rounded hover:bg-gray-100">
                                <input type="checkbox" id="period-${slot.period}" value="${slot.period}" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 mr-3 period-checkbox">
                                <div>
                                    <span class="font-medium">Period ${slot.period} (${periodDetails.time})</span>
                                    <span class="text-gray-600 text-sm block">${slot.level} ${slot.subject} (${slot.stream})</span>
                                </div>
                             </label>`;
                }).join('');
    
                periodSelectContainer.querySelectorAll('.period-checkbox').forEach(cb => {
                    cb.addEventListener('change', updateModalInteractiveState);
                });
            }
    
            function findAndRankTeachers(reliefContext) {
                const { originalTeacher, periods, details } = reliefContext;
                const periodIds = periods.map(p => p.id);
                const candidates = { G1: [], G2: [], G3: [], G4: [] }; 

                teachers.forEach(teacher => {
                    if (teacher.id === originalTeacher.id) return;

                    const weeklyLoad = teacher.reliefLoad || 0;
                    const dailyLoad = countDailyLoad(teacher);
                    const rationale = { "Daily Load": dailyLoad, "Weekly Relief Load": weeklyLoad };
                    
                    if (!teacher.available) {
                        rationale.Status = 'Unavailable for day';
                        candidates.G4.push({ teacher, rationale });
                        return;
                    }

                    const isFree = periodIds.every(pid => {
                        const slot = getTeacherTimetableSlot(teacher, pid);
                        return slot && (slot.status === 'free' || slot.status === 'blocked');
                    });

                    if (!isFree) {
                        rationale.Status = 'Teacher having lesson';
                        candidates.G4.push({ teacher, rationale });
                        return;
                    }
                    
                    // New constraints logic for available teachers
                    const startRelief = Math.min(...periodIds);
                    const endRelief = Math.max(...periodIds);

                    const hasLessonBefore = teacher.timetable.some(s => s.period === startRelief - 1 && s.status === 'teaching');
                    const hasLessonAfter = teacher.timetable.some(s => s.period === endRelief + 1 && s.status === 'teaching');

                    if (hasLessonBefore || hasLessonAfter) {
                        rationale.Continuity = 'Back-to-back';
                    }

                    const teachingPeriods = teacher.timetable.filter(s => s.status === 'teaching').map(s => s.period);
                    if (teachingPeriods.length > 0) {
                        const lastLessonPeriod = Math.max(...teachingPeriods);
                        if (startRelief > lastLessonPeriod) {
                            const gap = startRelief - lastLessonPeriod;
                            if (gap > 3) { 
                                 rationale.Gap = `Large (${gap - 1} periods)`;
                            }
                        }
                    }

                    // --- NEW TIERING LOGIC ---
                    
                    let isTier1 = false;
                    let isTier2 = false;

                    const teacherTimetable = fullTimetable[teacher.id] || {};
                    // Check for Tier 1: Perfect Match (Same Level, Subject, Stream)
                    for (const weekType in teacherTimetable) {
                        for (const day in teacherTimetable[weekType]) {
                            for (const slot of teacherTimetable[weekType][day]) {
                                if (slot.level === details.level && slot.subject === details.subject && slot.stream === details.stream) {
                                    isTier1 = true;
                                    break;
                                }
                            }
                            if (isTier1) break;
                        }
                        if (isTier1) break;
                    }

                    if (isTier1) {
                        candidates.G1.push({ teacher, rationale });
                        return; // Found best match, continue to next teacher
                    }

                    // Check for Tier 2: Subject Specialist (Same Subject, any Level)
                    if (teacher.subjects.includes(details.subject)) {
                        isTier2 = true;
                    }

                    if (isTier2) {
                        candidates.G2.push({ teacher, rationale });
                        return; // Found second-best match, continue to next teacher
                    }
                    
                    // If not Tier 1 or Tier 2, they are Tier 3
                    candidates.G3.push({ teacher, rationale });
                });
                
                const sortFn = (a, b) => (a.rationale['Daily Load'] - b.rationale['Daily Load']) || (a.rationale['Weekly Relief Load'] - b.rationale['Weekly Relief Load']);
                candidates.G1.sort(sortFn);
                candidates.G2.sort(sortFn);
                candidates.G3.sort(sortFn);

                return candidates;
            }
            
            function handleAssignment(teacherId) {
                if (!selectedReliefContext) {
                    alert("Please select a relief task first.");
                    return;
                }
    
                const assignedTeacher = getMasterTeacherDetails(teacherId);
                const dateKey = currentViewDate.format('YYYY-MM-DD');
                const taskIndex = reliefTasksByDate[dateKey].findIndex(t => t.id === selectedReliefContext.id);
    
                if (taskIndex === -1) {
                    alert("Error: Could not find the relief task.");
                    return;
                }
    
                // Update the current relief task
                reliefTasksByDate[dateKey][taskIndex].status = 'assigned';
                reliefTasksByDate[dateKey][taskIndex].assignedTeacher = { id: assignedTeacher.id, name: assignedTeacher.name };
                
                selectedReliefContext = null; // Clear context
                saveStateToFirestore();
            }
    
            function handleDeleteRelief() {
                 if (!taskToEdit) return;
                 const dateKey = dayjs(taskToEdit.date).format('YYYY-MM-DD');
                 const tasks = reliefTasksByDate[dateKey];
                 if (tasks) {
                     reliefTasksByDate[dateKey] = tasks.filter(t => t.id !== taskToEdit.id);
                     if (reliefTasksByDate[dateKey].length === 0) delete reliefTasksByDate[dateKey];
                     saveStateToFirestore();
                 }
                 closeModal(assignReliefModal);
            }
    
            function handleSplitAssignment(taskId) {
                const dateKey = currentViewDate.format('YYYY-MM-DD');
                const taskIndex = reliefTasksByDate[dateKey].findIndex(t => t.id === taskId);
                if (taskIndex === -1) return;
    
                const taskToSplit = reliefTasksByDate[dateKey][taskIndex];
                if (taskToSplit.periods.length <= 1) return; // Cannot split single period task
    
                const newTasks = taskToSplit.periods.map((period, i) => ({
                    ...taskToSplit,
                    id: `${taskToSplit.id}_split_${i+1}`,
                    periods: [period] // Each new task has one period
                }));
    
                // Replace the old task with the new split tasks
                reliefTasksByDate[dateKey].splice(taskIndex, 1, ...newTasks);
                saveStateToFirestore();
            }
    
            function handleCombineAssignments(taskId) {
                 const dateKey = currentViewDate.format('YYYY-MM-DD');
                 const tasks = reliefTasksByDate[dateKey].sort((a,b) => a.periods[0].id - b.periods[0].id);
                 const taskIndex = tasks.findIndex(t => t.id === taskId);
                 if (taskIndex === -1 || taskIndex + 1 >= tasks.length) return;
    
                 const currentTask = tasks[taskIndex];
                 const nextTask = tasks[taskIndex + 1];
    
                 // Combine periods
                 currentTask.periods = [...currentTask.periods, ...nextTask.periods].sort((a,b) => a.id - b.id);
    
                 // Remove the next task
                 reliefTasksByDate[dateKey] = tasks.filter(t => t.id !== nextTask.id);
    
                 saveStateToFirestore();
            }

            function handleUndoAssignment(taskId) {
                const dateKey = currentViewDate.format('YYYY-MM-DD');
                const tasks = reliefTasksByDate[dateKey];
                if (!tasks) return;

                const taskIndex = tasks.findIndex(t => t.id === taskId);
                if (taskIndex === -1) return;

                tasks[taskIndex].status = 'pending';
                delete tasks[taskIndex].assignedTeacher;

                if (selectedReliefContext && selectedReliefContext.id === taskId) {
                    selectedReliefContext = null;
                }

                saveStateToFirestore();
            }

            function handleDeleteAllForTeacher(teacherId) {
                const dateKey = dayjs(selectedReliefDateInModal).format('YYYY-MM-DD');
                const tasks = reliefTasksByDate[dateKey];
                if (!tasks) return;

                reliefTasksByDate[dateKey] = tasks.filter(task => task.originalTeacher.id !== teacherId);

                if (reliefTasksByDate[dateKey].length === 0) {
                    delete reliefTasksByDate[dateKey];
                }
                
                if (selectedReliefContext && selectedReliefContext.originalTeacher.id === teacherId) {
                    selectedReliefContext = null;
                }

                saveStateToFirestore();
            }
    
    
            function loadTimetableForDate(date) {
                dateDisplay.textContent = date.format('ddd, D MMM YYYY');
                const weekType = getWeekType(date);
                const dayOfWeek = date.format('dddd').toLowerCase();
                const dateKey = date.format('YYYY-MM-DD');
    
                // Reset daily teachers from master list
                teachers = JSON.parse(JSON.stringify(masterTeachers)); 
    
                teachers.forEach(teacher => {
                    // Initialize timetable for the day
                    teacher.timetable = PERIODS.map(p => ({ period: p.id, status: 'free' }));

                    // Apply master timetable
                    const schedule = fullTimetable[teacher.id]?.[weekType]?.[dayOfWeek] || [];
                    schedule.forEach(slot => {
                        const timetableSlot = teacher.timetable.find(ts => ts.period === slot.period);
                        if (timetableSlot) {
                            Object.assign(timetableSlot, { ...slot, status: 'teaching' });
                        }
                    });
                    
                    // Apply saved blockouts
                    const blockedPeriods = teacher.blockedSlotsByDate?.[dateKey] || [];
                     blockedPeriods.forEach(periodId => {
                         const slot = teacher.timetable.find(s => s.period === periodId);
                         if (slot && slot.status === 'free') {
                             slot.status = 'blocked';
                         }
                     });
    
                    // Check for unavailability (relief tasks where this teacher is original)
                    const isUnavailable = (reliefTasksByDate[dateKey] || []).some(task => task.originalTeacher.id === teacher.id);
                    teacher.available = !isUnavailable;
    
                    // Apply assigned relief duties
                    const reliefDuties = (reliefTasksByDate[dateKey] || []).filter(task => task.assignedTeacher && task.assignedTeacher.id === teacher.id);
                    reliefDuties.forEach(duty => {
                        duty.periods.forEach(p => {
                            const timetableSlot = teacher.timetable.find(ts => ts.period === p.id);
                            if (timetableSlot) {
                                timetableSlot.status = 'relief';
                                timetableSlot.subject = duty.details.subject;
                            }
                        });
                    });
                    
                    // Populate relief load for ranking
                    teacher.reliefLoad = Object.values(reliefTasksByDate).flat()
                        .filter(task => task.assignedTeacher && task.assignedTeacher.id === teacher.id)
                        .reduce((sum, task) => sum + task.periods.length, 0);
                });
    
                renderUI();
            }
            
            function renderUI() {
                renderReliefTasksSidebar();
                renderDepartmentTimetable();
                renderReliefLoad();
                renderDailySummary();
                updateReliefStatus();
            }
            
            function populatePeriodDropdowns() {
                const options = PERIODS.map(p => `<option value="${p.id}">Period ${p.id} (${p.time})</option>`).join('');
                startPeriodSelect.innerHTML = options;
                endPeriodSelect.innerHTML = options;
            }

             function updateReliefStatus() {
                const container = document.getElementById('reliefStatusContainer');
                const today = dayjs().startOf('day');
                const pendingDates = [];

                for (const dateKey in reliefTasksByDate) {
                    const date = dayjs(dateKey);
                    if (date.isBefore(today)) continue;

                    const hasPending = (reliefTasksByDate[dateKey] || []).some(task => task.status === 'pending');
                    if (hasPending) {
                        pendingDates.push(date);
                    }
                }

                if (pendingDates.length === 0) {
                    container.innerHTML = `<p class="text-sm font-semibold text-green-700">All relief periods are assigned.</p>`;
                    container.className = 'mt-6 mb-4 p-3 rounded-lg bg-green-100';
                } else {
                    const dateList = pendingDates
                        .sort((a, b) => a.diff(b))
                        .map(d => `<li class="font-semibold">${d.format('ddd, D MMM')}</li>`)
                        .join('');
                    container.innerHTML = `
                        <p class="text-sm font-semibold text-yellow-800">Pending relief assignments on:</p>
                        <ul class="list-disc list-inside text-xs mt-1">${dateList}</ul>
                    `;
                    container.className = 'mt-6 mb-4 p-3 rounded-lg bg-yellow-100';
                }
            }

            function renderDailySummary() {
                const container = document.getElementById('summary');
                const dateKey = currentViewDate.format('YYYY-MM-DD');
                const tasksForDay = (reliefTasksByDate[dateKey] || []).sort((a,b) => a.periods[0].id - b.periods[0].id);

                if (tasksForDay.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 mt-8">No relief assignments for this day.</p>`;
                    return;
                }

                const tableRows = tasksForDay.map(task => {
                    const periodText = `P${task.periods[0].id}` + (task.periods.length > 1 ? ` - P${task.periods[task.periods.length - 1].id}` : '');
                    const timeText = `${task.periods[0].time.split('-')[0]} - ${task.periods[task.periods.length - 1].time.split('-')[1]}`;
                    const classText = `${task.details.level} ${task.details.subject} (${task.details.stream})`;
                    const assignedTeacherText = task.assignedTeacher ? task.assignedTeacher.name : `<span class="italic text-gray-500">Pending</span>`;

                    let messageButton = '';
                    if (task.status === 'assigned') {
                        const messageData = {
                            original: task.originalTeacher.name,
                            cover: task.assignedTeacher.name,
                            class: classText,
                            period: periodText,
                            time: timeText,
                            date: currentViewDate.format('ddd, D MMM')
                        };
                        messageButton = `<button class="draft-message-btn bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded" data-message='${JSON.stringify(messageData)}'>Draft Message</button>`;
                    }

                    return `
                        <tr class="border-b">
                            <td class="p-3">${timeText}</td>
                            <td class="p-3">${periodText}</td>
                            <td class="p-3">${classText}</td>
                            <td class="p-3">${task.originalTeacher.name}</td>
                            <td class="p-3">${assignedTeacherText}</td>
                            <td class="p-3 text-center">${messageButton}</td>
                        </tr>
                    `;
                }).join('');

                container.innerHTML = `
                    <h3 class="text-xl font-semibold mb-4">Relief Summary for ${currentViewDate.format('dddd, D MMMM YYYY')}</h3>
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th class="p-3">Time</th>
                                    <th class="p-3">Period(s)</th>
                                    <th class="p-3">Class Details</th>
                                    <th class="p-3">Original Teacher</th>
                                    <th class="p-3">Covering Teacher</th>
                                    <th class="p-3 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;

                container.querySelectorAll('.draft-message-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const data = JSON.parse(e.target.dataset.message);
                        const message = `Dear ${data.cover},\n\nWe would like to seek your assistance with the following relief duty for ${data.original} on ${data.date}.\n\nClass: ${data.class}\nPeriod(s): ${data.period}\nTime: ${data.time}\nDetails: [Please add any further details here]\n\nDo let us know if you require further clarifications or have any concerns. Thank you!\n\n---\n\nDear ${data.original},\n\nThis is to inform you that ${data.cover} will be covering your lesson on ${data.date} for the class mentioned above.\n\nThank you.`;
                        
                        // Fallback for clipboard API
                        const textArea = document.createElement("textarea");
                        textArea.value = message;
                        textArea.style.position = "fixed";
                        textArea.style.top = 0;
                        textArea.style.left = 0;
                        textArea.style.opacity = 0;
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();

                        try {
                            const successful = document.execCommand('copy');
                            if (successful) {
                                const originalText = e.target.textContent;
                                e.target.textContent = 'Copied!';
                                e.target.disabled = true;
                                setTimeout(() => {
                                    e.target.textContent = originalText;
                                    e.target.disabled = false;
                                }, 2000);
                            } else {
                                throw new Error('Copy command was not successful');
                            }
                        } catch (err) {
                            console.error('Could not copy text: ', err);
                            const originalText = e.target.textContent;
                            e.target.textContent = 'Copy Failed';
                             setTimeout(() => {
                                e.target.textContent = originalText;
                            }, 2000);
                        }

                        document.body.removeChild(textArea);
                    });
                });
            }

            function initializeMockFullTimetable() {
                masterTeachers = [
                    { id: 't1', name: 'John Doe (Math)', department: 'Math', subjects: ['Math', 'Physics'] },
                    { id: 't2', name: 'Jane Smith (Math)', department: 'Math', subjects: ['Math'] },
                    { id: 't3', name: 'Peter Jones (Science)', department: 'Science', subjects: ['Chemistry', 'Biology'] },
                    { id: 't4', name: 'Mary Williams (Science)', department: 'Science', subjects: ['Physics', 'Chemistry'] },
                    { id: 't5', name: 'David Brown (English)', department: 'English', subjects: ['English Lit', 'History'] },
                    { id: 't6', name: 'Susan Davis', department: '', subjects: ['English Lang', 'Geography'] }
                ];

                fullTimetable = {
                    't1': { 
                        'Odd': {
                            'monday': [
                                { period: 1, level: 'Sec 3', subject: 'Math', stream: 'Express' },
                                { period: 2, level: 'Sec 3', subject: 'Math', stream: 'Express' },
                                { period: 5, level: 'Sec 4', subject: 'Physics', stream: 'NA' },
                            ],
                            'tuesday': [
                                { period: 3, level: 'Sec 2', subject: 'Math', stream: 'IP' },
                                { period: 4, level: 'Sec 2', subject: 'Math', stream: 'IP' },
                            ]
                        },
                        'Even': {
                            'monday': [
                                { period: 3, level: 'Sec 1', subject: 'Math', stream: 'Express' },
                                { period: 4, level: 'Sec 1', subject: 'Math', stream: 'Express' },
                            ],
                            'wednesday': [
                                { period: 9, level: 'Sec 4', subject: 'Physics', stream: 'NA' },
                                { period: 10, level: 'Sec 4', subject: 'Physics', stream: 'NA' },
                            ]
                        }
                    },
                    't3': { 
                        'Odd': {
                            'monday': [
                                { period: 1, level: 'Sec 3', subject: 'Chemistry', stream: 'Express' },
                                { period: 2, level: 'Sec 3', subject: 'Chemistry', stream: 'Express' },
                            ],
                        },
                        'Even': {
                            'tuesday': [
                                { period: 7, level: 'Sec 2', subject: 'Biology', stream: 'NA' },
                                { period: 8, level: 'Sec 2', subject: 'Biology', stream: 'NA' },
                            ]
                        }
                    }
                };
            }

            function addMockReliefTasks(date) {
                const dateKey = date.format('YYYY-MM-DD');
                if (masterTeachers.length === 0) return;
                const teacherForRelief = masterTeachers[0]; 
                
                const weekType = getWeekType(date);
                const dayOfWeek = date.format('dddd').toLowerCase();
                const schedule = fullTimetable[teacherForRelief.id]?.[weekType]?.[dayOfWeek];

                if (schedule && schedule.length > 0) {
                     if (!reliefTasksByDate[dateKey]) reliefTasksByDate[dateKey] = [];
                    
                    const firstClass = schedule[0];
                    reliefTasksByDate[dateKey].push({
                        id: 'mock_task_1',
                        date: dateKey,
                        periods: [getPeriodDetails(firstClass.period)],
                        details: { subject: firstClass.subject, level: firstClass.level, stream: firstClass.stream },
                        originalTeacher: {id: teacherForRelief.id, name: teacherForRelief.name, department: teacherForRelief.department},
                        status: 'pending'
                    });
                }
            }
            
            function updateModalInteractiveState() {
                const selectedType = document.querySelector('input[name="reliefType"]:checked').value;
                const teacherId = teacherSelect.value;
                const summaryEl = document.getElementById('reliefSelectionSummary');
                
                if (summaryEl) summaryEl.textContent = '';
                findTeachersBtn.disabled = true;

                if (!teacherId) {
                    return;
                }

                const weekType = getWeekType(selectedReliefDateInModal);
                const dayOfWeek = selectedReliefDateInModal.format('dddd').toLowerCase();
                const teacherTimetableForDay = (fullTimetable[teacherId]?.[weekType]?.[dayOfWeek] || []);
                const teachingPeriods = teacherTimetableForDay.map(slot => slot.period);

                if (selectedType === 'specific') {
                    const anyChecked = periodSelectContainer.querySelectorAll('.period-checkbox:checked').length > 0;
                    if (anyChecked) {
                        findTeachersBtn.disabled = false;
                    }
                } else if (selectedType === 'range') {
                    const options = teacherTimetableForDay.map(slot => {
                         const p = getPeriodDetails(slot.period);
                         return `<option value="${p.id}">Period ${p.id} (${p.time})</option>`;
                    }).join('');

                    startPeriodSelect.innerHTML = options;
                    endPeriodSelect.innerHTML = options;

                    if(teacherTimetableForDay.length > 0) {
                        const startVal = parseInt(startPeriodSelect.value);
                        const endVal = parseInt(endPeriodSelect.value);
                        if (!isNaN(startVal) && !isNaN(endVal) && endVal >= startVal) {
                             findTeachersBtn.disabled = false;
                        }
                    }
                } else if (selectedType === 'fullDay') {
                    if (teachingPeriods.length > 0) {
                        findTeachersBtn.disabled = false;
                        if (summaryEl) summaryEl.textContent = `This will create relief tasks for periods: P${teachingPeriods.join(', P')}.`;
                    } else {
                        if (summaryEl) summaryEl.textContent = 'This teacher has no scheduled classes on this date.';
                    }
                }
            }
    
            function initializeApp() {
                assignReliefBtn.addEventListener('click', () => {
                    resetAssignReliefModal();
                    openModal(assignReliefModal);
                });
                closeAssignReliefModalBtn.addEventListener('click', () => closeModal(assignReliefModal));
                modalBackdrop.addEventListener('click', () => {
                    closeModal(assignReliefModal);
                    closeModal(settingsModal);
                });
                settingsBtn.addEventListener('click', () => openModal(settingsModal));
                closeSettingsModal.addEventListener('click', () => closeModal(settingsModal));
                saveSettingsBtn.addEventListener('click', () => {
                     termStartDates.term1 = dayjs(term1Input.value);
                     termStartDates.term2 = dayjs(term2Input.value);
                     termStartDates.term3 = dayjs(term3Input.value);
                     termStartDates.term4 = dayjs(term4Input.value);
                     saveStateToFirestore();
                });
                downloadTemplateLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    const csvHeaders = ['Teacher'];
                    const weeks = ['Odd', 'Even'];
                    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
                    for (const week of weeks) {
                        for (const day of days) {
                            for (let p = 1; p <= 16; p++) {
                                csvHeaders.push(`"${week} ${day} P${p}"`);
                            }
                        }
                    }

                    const exampleRow = new Array(csvHeaders.length).fill('');
                    exampleRow[0] = '"Ms Tan (Math)"';
                    exampleRow[1] = '"1 Math 1E"';
                    exampleRow[1 + 16 + 4] = '"2 Math 2A"';

                    const csvContent = [
                        csvHeaders.join(','),
                        exampleRow.join(',')
                    ].join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    if (link.download !== undefined) { 
                        const url = URL.createObjectURL(blob);
                        link.setAttribute("href", url);
                        link.setAttribute("download", "timetable_template_wide_format.csv");
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                });
                uploadBtn.addEventListener('click', () => fileUploader.click());
                fileUploader.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            processTimetableCSV(event.target.result);
                            document.getElementById('uploadBtnText').textContent = 'Upload Successful!';
                            setTimeout(() => {
                                document.getElementById('uploadBtnText').textContent = 'Upload CSV Timetable';
                                closeModal(settingsModal);
                            }, 2000);
                        } catch (error) {
                            console.error("CSV Parsing Error:", error);
                            alert("Failed to parse the timetable file. Please check the file format and content. Error: " + error.message);
                             document.getElementById('uploadBtnText').textContent = 'Upload Failed!';
                             setTimeout(() => {
                                document.getElementById('uploadBtnText').textContent = 'Upload CSV Timetable';
                            }, 3000);
                        }
                    };
                    reader.readAsText(file);
                    e.target.value = ''; // Reset file input
                });
                blockOutBtn.addEventListener('click', () => {
                    if (isBlockOutMode) {
                        exitBlockOutMode(false); // Cancel if clicked again
                    } else {
                        enterBlockOutMode();
                    }
                });
                saveBlocksBtn.addEventListener('click', () => exitBlockOutMode(true));
                cancelBlockOutBtn.addEventListener('click', () => exitBlockOutMode(false));
                resetBlocksBtn.addEventListener('click', () => {
                    blockOutTeachers = JSON.parse(JSON.stringify(teachers)); // Reset to initial state for the day
                    renderDepartmentTimetable();
                });
                
                teacherSelect.addEventListener('change', (e) => {
                    if(e.target.value) {
                         updatePeriodSelectionForTeacher(e.target.value);
                    } else {
                         periodSelectContainer.innerHTML = `<p class="text-gray-500">Please select a teacher and date.</p>`;
                    }
                    updateModalInteractiveState();
                });
    
                reliefTypeContainer.addEventListener('change', () => {
                    togglePeriodSelectionUI();
                    updateModalInteractiveState();
                });

                startPeriodSelect.addEventListener('change', updateModalInteractiveState);
                endPeriodSelect.addEventListener('change', updateModalInteractiveState);

                clearDayReliefBtn.addEventListener('click', () => {
                    const dateKey = currentViewDate.format('YYYY-MM-DD');
                    if(reliefTasksByDate[dateKey]) {
                        delete reliefTasksByDate[dateKey];
                        if (selectedReliefContext && selectedReliefContext.date === dateKey) {
                            selectedReliefContext = null;
                        }
                        saveStateToFirestore();
                    }
                });

                deleteAllTasksBtn.addEventListener('click', () => {
                    if (taskToEdit) {
                        handleDeleteAllForTeacher(taskToEdit.originalTeacher.id);
                        closeModal(assignReliefModal);
                    }
                });
    
                findTeachersBtn.addEventListener('click', () => {
                    const teacherId = teacherSelect.value;
                    const selectedType = document.querySelector('input[name="reliefType"]:checked').value;
                    let selectedPeriods = [];
    
                    const errorMessageEl = document.getElementById('modalErrorMessage');
                    errorMessageEl.classList.add('hidden');

                    const dateKeyForCheck = selectedReliefDateInModal.format('YYYY-MM-DD');
                    const tasksForDay = reliefTasksByDate[dateKeyForCheck] || [];
                    const isTeacherAlreadyUnavailable = tasksForDay.some(task => task.originalTeacher.id === teacherId);

                    if (modalMode === 'new' && isTeacherAlreadyUnavailable) {
                        errorMessageEl.textContent = 'This teacher has already been marked as unavailable for this day.';
                        errorMessageEl.classList.remove('hidden');
                        return; 
                    }

                    if (selectedType === 'specific') {
                        selectedPeriods = Array.from(document.querySelectorAll('.period-checkbox:checked')).map(cb => parseInt(cb.value));
                    } else if (selectedType === 'range') {
                        const start = parseInt(startPeriodSelect.value);
                        const end = parseInt(endPeriodSelect.value);
                        for (let i = start; i <= end; i++) {
                             if ([...startPeriodSelect.options].some(opt => parseInt(opt.value) === i)) {
                                selectedPeriods.push(i);
                             }
                        }
                    } else { // fullDay
                        const weekType = getWeekType(selectedReliefDateInModal);
                        const dayOfWeek = selectedReliefDateInModal.format('dddd').toLowerCase();
                        const teacherTimetableForDay = (fullTimetable[teacherId]?.[weekType]?.[dayOfWeek] || []);
                        selectedPeriods = teacherTimetableForDay.map(slot => slot.period);
                    }
                    
                    if (selectedPeriods.length === 0) {
                        alert("Please select at least one period. For 'Full Day' or 'Period Range' relief, ensure the teacher has scheduled classes on the selected date.");
                        return;
                    }
    
                    const weekType = getWeekType(selectedReliefDateInModal);
                    const dayOfWeek = selectedReliefDateInModal.format('dddd').toLowerCase();
                    const teacherTimetable = fullTimetable[teacherId]?.[weekType]?.[dayOfWeek] || [];

                    const sortedReliefDetails = selectedPeriods
                        .map(pid => {
                            const classInfo = teacherTimetable.find(slot => slot.period === pid);
                            return { 
                                period: getPeriodDetails(pid), 
                                details: classInfo ? { subject: classInfo.subject, level: classInfo.level, stream: classInfo.stream } : { subject: null, level: null, stream: null } 
                            };
                        })
                        .sort((a, b) => a.period.id - b.period.id);

                    const taskGroups = [];
                    let currentGroup = [];

                    sortedReliefDetails.forEach(reliefDetail => {
                        if (currentGroup.length === 0) {
                            currentGroup.push(reliefDetail);
                        } else {
                            const lastInGroup = currentGroup[currentGroup.length - 1];
                            const isConsecutive = reliefDetail.period.id === lastInGroup.period.id + 1;
                            const isSameClass =
                                reliefDetail.details.subject === lastInGroup.details.subject &&
                                reliefDetail.details.level === lastInGroup.details.level &&
                                reliefDetail.details.stream === lastInGroup.details.stream;

                            if (isConsecutive && isSameClass) {
                                currentGroup.push(reliefDetail);
                            } else {
                                taskGroups.push(currentGroup);
                                currentGroup = [reliefDetail];
                            }
                        }
                    });
                    if (currentGroup.length > 0) {
                        taskGroups.push(currentGroup);
                    }

                    const newTasks = taskGroups.map(group => ({
                        id: `task_${Date.now()}_${Math.random()}`,
                        date: selectedReliefDateInModal.format('YYYY-MM-DD'),
                        periods: group.map(d => d.period),
                        details: group[0]?.details || {},
                        originalTeacher: getMasterTeacherDetails(teacherId),
                        status: 'pending',
                    }));

                    const dateKey = selectedReliefDateInModal.format('YYYY-MM-DD');
                    if (!reliefTasksByDate[dateKey]) {
                        reliefTasksByDate[dateKey] = [];
                    }

                    if (modalMode === 'edit' && taskToEdit) {
                        reliefTasksByDate[dateKey] = reliefTasksByDate[dateKey].filter(t => t.id !== taskToEdit.id);
                        reliefTasksByDate[dateKey].push(...newTasks);
                    } else {
                        reliefTasksByDate[dateKey].push(...newTasks);
                    }
    
                    saveStateToFirestore();
                    currentViewDate = selectedReliefDateInModal;
                    loadTimetableForDate(currentViewDate);
                    closeModal(assignReliefModal);
                });
    
                deleteReliefBtn.addEventListener('click', handleDeleteRelief);
    
                prevDayBtn.addEventListener('click', () => {
                    currentViewDate = currentViewDate.subtract(1, 'day');
                    loadTimetableForDate(currentViewDate);
                });
                nextDayBtn.addEventListener('click', () => {
                    currentViewDate = currentViewDate.add(1, 'day');
                    loadTimetableForDate(currentViewDate);
                });
                todayBtn.addEventListener('click', () => {
                    currentViewDate = dayjs();
                    loadTimetableForDate(currentViewDate);
                });
    
    
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const tabId = button.dataset.tab;
                        tabButtons.forEach(btn => btn.classList.toggle('tab-active', btn === button));
                        tabContents.forEach(content => content.classList.toggle('hidden', content.id !== tabId));
                    });
                });
    
                populatePeriodDropdowns();
            }

            function parseClassDetails(detailsString) {
                if (!detailsString || detailsString.trim() === '') return null;
                let workingString = detailsString.trim().replace(/^"|"$/g, '');

                if (workingString.toLowerCase() === 'assy') return { subject: 'Assembly', level: '', stream: '' };
                if (workingString.toLowerCase() === 'pd/dept/staffm') return { subject: 'Meeting', level: '', stream: '' };

                let level = '', subject = '', stream = '';
                
                const streamMatch = workingString.match(/\s?\(?([A-Z]\d+)\)?$/i);
                if (streamMatch) {
                    stream = streamMatch[1].toUpperCase();
                    workingString = workingString.substring(0, streamMatch.index).trim();
                }

                const levelMatch = workingString.match(/^(\d+)\s/);
                if (levelMatch) {
                    level = `Sec ${levelMatch[1]}`;
                    subject = workingString.substring(levelMatch[0].length).trim();
                } else {
                    subject = workingString;
                }

                 subject = subject.replace(/([a-z])\(([A-Z])/g, '$1 ($2');

                return { level, subject, stream };
            }

            function processTimetableCSV(csvContent) {
                const lines = csvContent.trim().split(/\r?\n/);
                if (lines.length < 2) throw new Error("CSV file must have at least a header and one teacher row.");

                const headers = lines[0].split(',').map(h => h.trim());
                
                const newMasterTeachers = new Map();
                const newFullTimetable = {};

                const dayMap = { Mon: 'monday', Tue: 'tuesday', Wed: 'wednesday', Thu: 'thursday', Fri: 'friday' };

                for (let i = 1; i < lines.length; i++) {
                    const data = lines[i].split(',');
                    const teacherNameRaw = data[0].trim();
                    if (!teacherNameRaw) continue;
                    
                    const fullTeacherName = teacherNameRaw.replace(/^"|"$/g, '');
                    const nameMatch = fullTeacherName.match(/(.+?)(?: \((.+)\))?$/);
                    const department = nameMatch ? (nameMatch[2] || '') : '';
                    const teacherId = 't_' + fullTeacherName.toLowerCase().replace(/[^a-z0-9]/g, '_');

                    if (!newMasterTeachers.has(teacherId)) {
                        newMasterTeachers.set(teacherId, { id: teacherId, name: fullTeacherName, department, subjects: [] });
                    }
                    const teacher = newMasterTeachers.get(teacherId);

                    for (let j = 1; j < headers.length; j++) {
                        const classDetailsString = data[j];
                        if (!classDetailsString || classDetailsString.trim() === '') continue;

                        const header = headers[j].replace(/^"|"$/g, '');
                        const headerMatch = header.match(/(Odd|Even)\s(Mon|Tue|Wed|Thu|Fri)\sP(\d+)/i);
                        if (!headerMatch) continue;
                        
                        const weekType = headerMatch[1].charAt(0).toUpperCase() + headerMatch[1].slice(1).toLowerCase();
                        const day = dayMap[headerMatch[2]];
                        const period = parseInt(headerMatch[3]);
                        
                        const classDetails = parseClassDetails(classDetailsString);
                        if (!classDetails) continue;

                        if (classDetails.subject && !teacher.subjects.includes(classDetails.subject)) {
                            teacher.subjects.push(classDetails.subject);
                        }

                        if (!newFullTimetable[teacherId]) newFullTimetable[teacherId] = {};
                        if (!newFullTimetable[teacherId][weekType]) newFullTimetable[teacherId][weekType] = {};
                        if (!newFullTimetable[teacherId][weekType][day]) newFullTimetable[teacherId][weekType][day] = [];
                        
                        newFullTimetable[teacherId][weekType][day].push({
                            period,
                            level: classDetails.level,
                            subject: classDetails.subject,
                            stream: classDetails.stream
                        });
                    }
                }
                
                masterTeachers = Array.from(newMasterTeachers.values());
                fullTimetable = newFullTimetable;
                reliefTasksByDate = {}; 
                selectedReliefContext = null;

                saveStateToFirestore();
            }
        }
        
        initializeFirebase();

    </script>
    
</body>
</html>


